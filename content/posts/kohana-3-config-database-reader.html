<p>This post explains how to create a custom Config Database Reader class for your Kohana 3 application. You can attach multiple readers to the config allowing you to get config data from different sources. Kohana 3.0.8 comes with a config database reader in the database module, but it doesn&#8217;t include any sort of caching, and if you&#8217;re requesting many config groups then it will generate many queries.</p>
<p>This variation of the config database class will read and cache the entire config table.</p>
<p>There&#8217;s two things you&#8217;ll need to do to integrate database config:</p>
<ol><li>Add the database schema for the config table</li>
<li>Create the database reader class</li>
</ol><p>You can find the MySQL config database schema here: <a href="https://gist.github.com/729187"><a href="https://gist.github.com/729187">https://gist.github.com/729187</a></a>, or copy the following SQL:</p>
<pre class="prettyprint lang-sql">CREATE TABLE IF NOT EXISTS `config` (<br/>  `id` int(11) NOT NULL auto_increment,<br/>  `group_name` varchar(32) character set utf8 NOT NULL,<br/>  `config_key` varchar(32) character set utf8 NOT NULL,<br/>  `label` varchar(64) character set utf8 NOT NULL,<br/>  `config_value` text character set utf8,<br/>  `default` text character set utf8,<br/>  `rules` text character set utf8,<br/>  `field_type` varchar(255) character set utf8 NOT NULL default 'text',<br/>  `date` timestamp NOT NULL default CURRENT_TIMESTAMP,<br/>  PRIMARY KEY  (`id`),<br/>  UNIQUE KEY `group` (`group_name`,`config_key`)<br/>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br/><br/></pre>
<p>Create the file &#8216;<a href="https://github.com/badsyntax/kohana3-base/blob/7dd4e5c4a191bedcb1e568d1760263c4fd2282e4/classes/config/database.php">classes/config/database.php</a>&#8217;. Here&#8217;s a snippet from the class, showing the caching logic in the load() function:</p>
<pre class="prettyprint lang-php linenums">/**<br/> * Query the configuration table for all values for this group,<br/> * and store the data in cache.<br/> *<br/> * @param   string  group name<br/> * @param   array   configuration array<br/> * @return  $this   clone of the current object<br/> */<br/>public function load($group, array $config = NULL)<br/>{<br/> if ( $config !== NULL OR $group === 'database' OR $group === 'cache')<br/>  {<br/>    return parent::load($group, $config);<br/>  }<br/><br/> // Try get the config from cache<br/> $cache = Cache::instance()-&gt;get(self::$_cache_key);  <br/><br/>  if (!$cache)<br/> {<br/>    // Load all of the configuration values<br/>    $query = DB::select('config_key', 'config_value', 'group_name')<br/>      -&gt;from($this-&gt;_database_table)<br/>     -&gt;execute();<br/><br/>   if (count($query) &gt; 0)<br/>    {<br/>      $cache = array();<br/><br/>     // Build the cache configuration array that contains ALL the config entries<br/>      foreach($query as $entry)<br/>      {<br/>        if (!isset($cache[$entry['group_name']]))<br/>        {<br/>          $cache[$entry['group_name']] = array();<br/>        }<br/><br/>       $cache[$entry['group_name']][$entry['config_key']] = unserialize($entry['config_value']);<br/>      }<br/><br/>     // Save the configuration in cache<br/>     Cache::instance()-&gt;set(self::$_cache_key, $cache, $this-&gt;_cache_lifetime);<br/>   }<br/>  }<br/><br/> // Use the group config if it exists<br/> $config = @$cache[$group];<br/><br/>  return parent::load($group, $config);<br/>}<br/><br/></pre>
<p>Database config data is cached indefinitely or until the cache has been cleared. This class doesn&#8217;t handle clearing of cache, you should do that elsewhere (like in a config controller).</p>
<p>The &#8216;config_value&#8217;, &#8216;default&#8217; and &#8216;rules&#8217; data has to be serialized before being saved to the database. <a href="https://github.com/badsyntax/kohana3-admin/blob/78667d09c868d5f5247b1663679d7c88e9bba904/classes/controller/admin/migrations.php#L60">View an example</a> of how to save config data.</p>
<p>Leave any comments or questions your might have below.</p>