<p>This posts explains and demonstrates how to generate hierarchical data trees using ORM models. This method should NOT be used for large trees as it uses recursion to traverse the tree, which generates many queries. If you have large tree with many levels, I suggest using something like <a href="https://github.com/kiall/kohana3-orm_mptt">ORM MPTT.</a></p>
<p>Let&#8217;s say we have a table called &#8216;pages&#8217; with a column &#8216;parent_id&#8217;, which is a foreign key to the table id. This is a fairly common and basic schema layout for data trees.<br/>MySQL example:</p>
<pre class="prettyprint lang-sql">CREATE TABLE IF NOT EXISTS `pages` (<br/>  `id` int(11) NOT NULL auto_increment,<br/>  `user_id` int(11) NOT NULL,<br/>  `parent_id` int(11) NOT NULL,<br/>  `title` varchar(128) NOT NULL,<br/>  `uri` varchar(255) NOT NULL,<br/>  `description` varchar(255) NOT NULL,<br/>  `body` text NOT NULL,<br/>  `date` timestamp NOT NULL default CURRENT_TIMESTAMP,<br/>  PRIMARY KEY  (`id`),<br/>  KEY `fk_user_id` (`user_id`),<br/>  KEY `fk_page_id` (`parent_id`)<br/>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br/></pre>
<p>We&#8217;ll need to define the database relationships in the model to gain easy access to children relationships. This can be done by specifying the belongs_to and has_many relationships to point to itself. For example:</p>
<pre class="prettyprint lang-php">&lt;?php defined('SYSPATH') or die('No direct script access.');<br/><br/>class Model_Page extends ORM {<br/><br/> protected $_belongs_to = array(<br/>    'parent' =&gt; array('model' =&gt; 'page', 'foreign_key' =&gt; 'parent_id'),<br/> );<br/><br/>  protected $_has_many = array(<br/>    'children' =&gt; array('model' =&gt; 'page', 'foreign_key' =&gt; 'parent_id'),<br/> );<br/>}<br/></pre>
<p>This allows us to gain access to children relationships like so:</p>
<pre class="prettyprint lang-php">$page = ORM::factory('page', 1);<br/><br/>$children_pages = $page-&gt;children-&gt;find_all();<br/></pre>
<p>So now all we need to do is build a function to recurse through the tree. I&#8217;ve created two example methods which might come in handy for you.</p>
<p>The first method &#8216;tree_select()&#8217; will return a single dimensional associative array, with indented values. You would pass this array into the <a href="http://kohanaframework.org/guide/api/Form#select">select Form helper</a> method.</p>
<p>The second method is used to generate an HTML tree. It uses view fragments to generate the HTML so you always have complete control over the HTML. You could use this method to build a site navigation.</p>
<p>Here&#8217;s the full example for a base page model.</p>
<pre class="prettyprint lang-php">&lt;?php defined('SYSPATH') or die('No direct script access.');<br/><br/>class Model_Page extends ORM {<br/><br/> protected $_belongs_to = array(<br/>    'parent' =&gt; array('model' =&gt; 'page', 'foreign_key' =&gt; 'parent_id'),<br/> );<br/><br/>  protected $_has_many = array(<br/>    'children' =&gt; array('model' =&gt; 'page', 'foreign_key' =&gt; 'parent_id'),<br/> );<br/><br/>  public function tree_select($indent = 4, $start_id = 0, $pages = array())<br/>  {<br/>    $start = $this-&gt;where('parent_id', '=', $start_id);<br/><br/>    $this-&gt;recurse_tree_select($start-&gt;find_all(), $pages, $indent);<br/><br/>    return $pages;<br/> } <br/><br/>  public function tree_list_html($view_path = NULL, $start_id = 0, $list_html = '')<br/>  {<br/>    $start = $this-&gt;where('parent_id', '=', $start_id);<br/><br/>    $this-&gt;recurse_tree_list_html($start-&gt;find_all(), $list_html, $view_path);<br/><br/>    return $list_html;<br/> }<br/><br/> private function recurse_tree_select($pages, &amp; $array = array(), $indent = 4, &amp; $depth = 0)<br/>  {<br/>    foreach($pages as $page)<br/>   {<br/>      $array[$page-&gt;id] = str_repeat(' ', ($depth * $indent)).$page-&gt;title;<br/><br/>     $children = $page-&gt;children-&gt;find_all();<br/><br/>      if (count($children))<br/>      {<br/>        $child_depth = $depth + 1;<br/><br/>        $this-&gt;recurse_tree_select($children, $array, $indent, $child_depth);<br/>     }<br/>    }   <br/> }<br/><br/> private function recurse_tree_list_html($pages, &amp; $html = '', $view_path = 'tree', &amp; $depth = -1)<br/>  {<br/>    $depth++;<br/><br/>   $has_pages = (count($pages) &gt; 0);<br/><br/>    $has_pages AND $html .= View::factory($view_path.'/list_open');<br/><br/>   foreach($pages as $page)<br/>   {<br/>      $html .= View::factory($view_path.'/item_open')-&gt;set('page', $page);<br/><br/>     $children = $page-&gt;children-&gt;find_all();<br/><br/>      $this-&gt;recurse_tree_list_html($children, $html, $view_path, $depth);<br/><br/>     $html .= View::factory($view_path.'/item_close');<br/>    }<br/><br/>   $has_pages AND $html .= View::factory($view_path.'/list_close');<br/> } <br/>} </pre>
<p>You&#8217;ll need to create views to be able to use the recurse_tree_list_html() method. Take a look at my <a href="https://github.com/badsyntax/kohana3-admin/tree/418ab57b350aa03d3bd69519c867b385ee69dc0b/views/admin/page/pages/tree">ko3 admin repo</a> to view examples.</p>